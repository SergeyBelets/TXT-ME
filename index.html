<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.jpg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>txt-me club</title>

  <script>
    (function() {
      try {
        // 1. Проверяем наличие критических данных
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');

        // Если что-то пошло не так в данных профиля (например, после обновления API)
        // можно добавить проверку версии приложения
        const APP_VER = '1.0.1';
        const currentVer = localStorage.getItem('app_version');

        if (currentVer !== APP_VER) {
           // Если версия не совпадает, мягко чистим всё, кроме токена,
           // чтобы не выкидывать пользователя из сессии, но обновить структуру данных
           const savedToken = localStorage.getItem('token');
           localStorage.clear();
           if (savedToken) localStorage.setItem('token', savedToken);
           localStorage.setItem('app_version', APP_VER);
           console.log('Storage partial reset performed');
        }

        // 2. Глобальный перехватчик ошибок для "белого экрана"
        window.onerror = function(message, source, lineno, colno, error) {
          if (message.includes('Script error') || message.includes('Render')) {
            // Если упало при загрузке — пробуем один раз очистить всё и перезагрузить
            if (!sessionStorage.getItem('recovery_attempted')) {
              sessionStorage.setItem('recovery_attempted', 'true');
              localStorage.clear();
              window.location.reload();
            }
          }
        };
      } catch (e) {
        console.error('Safe boot failed', e);
      }
    })();
  </script>
</head>
<body>
<script>
  (function() {
    // 1. Лечим баг квоты Safari (особенно актуально для твоих аватаров в Base64)
    try {
      localStorage.setItem('test', '1');
      localStorage.removeItem('test');
    } catch (e) {
      console.warn('Storage blocked - clearing to rescue');
      localStorage.clear(); // Сброс спасает от "белого экрана"
    }

    // 2. Глобальный предохранитель для ошибок модулей
    window.addEventListener('error', function(e) {
      if (e.message === 'Script error.' || e.message.includes('MIME')) {
        console.error('Critical loading error. Force reload might help.');
        if (!sessionStorage.getItem('reloaded')) {
          sessionStorage.setItem('reloaded', 'true');
          window.location.reload(true);
        }
      }
    }, true);
  })();
</script>
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>
</html>
